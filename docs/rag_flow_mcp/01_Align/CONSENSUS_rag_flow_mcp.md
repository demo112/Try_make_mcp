# 阶段1：共识 - RAG Flow MCP v2.2

## 1. 需求定义
构建一个深度集成于 6A 工作流的 **智能知识治理系统**。
不仅仅是回答问题，更是管理评审过程中知识的流动、验证与沉淀，并确保系统的**可靠性**与**真实性**。

## 2. 核心共识

### 2.1 知识分层与隔离
必须严格遵守以下分层，防止知识污染：
- **L1 全局 (金标)**: 全企业通用的规范（如安全红线、编码规范）。**[项目只读]**
- **L2 产品 (金标)**: 特定产品线的稳定知识（如支付网关接口定义）。**[项目只读]**
- **L3 项目 (临时)**: 当前评审项目产生的临时知识。**[读写]**

### 2.2 强制技术卡点
系统必须在代码层面强制执行以下检查，**不允许绕过**：
1.  **卡点 1: 初始化检查**
    - `init_review` 时，必须检测 `ALIGNMENT` 文档是否存在合法的 YAML 前置元数据 (产品/模块)。
    - **失败动作**: 报错并拒绝初始化后续文档。
2.  **卡点 2: 验证检查**
    - `harvest_knowledge` 后，必须自动触发 `GovernanceEngine.validate_conflict`。
    - **失败动作**: 标记冲突条目，禁止自动入库。
3.  **卡点 3: 晋升检查**
    - `promote_knowledge` 时，必须检测 `Promotion_Request.md` 是否包含有效的架构师签名 (`[Approved by: ...]`)。
    - **失败动作**: 拒绝写入 L1/L2 知识库。
4.  **卡点 4: 真实性检查**
    - 在生成建议前，必须评估检索内容的置信度。
    - **失败动作**: 若置信度低于阈值，必须明确输出“未找到相关信息”，严禁编造。

### 2.3 可靠性与容错策略
为了应对外部依赖的不确定性，必须实现以下机制：
1.  **自动重试机制**:
    - 针对 RAGFlow API 调用和 LLM 推理，实施指数退避 (Exponential Backoff) 重试策略。
    - 最大重试次数：3次。
2.  **降级策略 (Fallback)**:
    - 若 RAG 服务不可用：降级为仅进行本地规则检查，或在文档中标记“服务暂时不可用，请人工查阅”。
    - 若 LLM 响应超时：跳过当前条目的建议生成，不阻塞整个文档的处理。
3.  **异常处理**:
    - 所有模块必须捕获异常，并记录详细日志（包括上下文信息）。
    - 严禁因单个条目的处理失败导致整个程序崩溃。

### 2.4 交互与输出规范 (Interaction & Output Standards) - **NEW**
1.  **单点聚焦 (Single Focus)**:
    - AI 在回答问题时，必须**每次仅聚焦回答一个问题**。
    - 严禁合并回答或在一次回答中混杂无关信息。
2.  **输出格式 (Structured Output)**:
    - AI 解答必须具备明显标识、来源及置信度。
    - **标准格式**:
      ```markdown
      > 🤖 **AI 解答** (置信度: 0.85)
      >
      > [此处为 AI 生成的具体回答内容]
      >
      > 📚 **来源**:
      > - `文档名称.md` (章节: 3.1 核心架构)
      ```
3.  **文档优先**: 所有的输入（问题）和输出（答案、审批单）必须以 Markdown 文档为载体。
4.  **独立字段**: AI 生成的内容必须写入 `**AI 参考建议**`，严禁触碰 `**回答**` 字段。
5.  **人工最终决策**: 只有 `**回答**` 字段的内容会被收割进知识库。

## 3. 技术实现边界
- **协议**: MCP (Model Context Protocol) over Stdio。
- **核心依赖**: 
    - RAGFlow API (提供向量检索与 LLM 能力)。
    - Python 3.10+ (逻辑层)。
- **交付物**: 
    - `rag_flow_mcp` (包含 推理、治理、生命周期、进化 四大引擎)。
    - 预置的 MCP 工具 (`fill_clarification_suggestions`, `evolve_scheme_document`, `check_metadata_compliance`, `validate_knowledge_conflict`, `harvest_knowledge_candidates`, `promote_knowledge`, `list_knowledge_bases`, `list_knowledge_base_files`)。

## 5. 生产环境升级共识 (v2.1 P0)
### 5.1 稳健性共识
*   **AST 优先**: 所有的文档修改操作（如进化、填充建议）必须基于 Markdown AST。禁止使用正则或纯字符串替换来处理复杂的文档结构。
*   **结构保护**: 在修改文档时，必须显式校验修改前后的 DOM 结构差异，确保 H1-H6 层级、表格列数、Mermaid 代码块未被破坏。

### 5.2 协作共识 (轻量化)
*   **影子副本机制 (Shadow Copy)**:
    *   MCP **严禁**直接修改原 Markdown 文件（如 `DESIGN.md`）。
    *   所有的写操作必须输出到 `{filename}_ai_revision.md`。
    *   同时生成 `{filename}_diff_report.md`，以直观展示修改内容。
    *   **人工确认**: 用户通过文件对比工具确认无误后，手动执行覆盖或合并。

### 5.3 质量共识
*   **测试门禁**:
    *   项目根目录下维护 `tests/golden_dataset.json`。
    *   CI 或发布前必须运行 `python tests/run_inference_test.py`。
    *   **通过标准**: 平均语义相似度 score > 0.8 (使用轻量级 LLM 或 Embedding Distance 判定)。

## 6. 基础架构升级共识 (v2.2)

### 6.1 配置管理共识
*   **单一事实来源**: 所有环境相关配置必须通过 `.env` 文件加载。
*   **优先级**: 环境变量 > `.env` 文件 > 默认值。
*   **敏感信息**: API Key 等敏感信息严禁硬编码，必须通过 `.env` 管理，且 `.env` 必须加入 `.gitignore`。
*   **打包支持**: 打包为 EXE 时，必须支持从 EXE 同级目录读取 `.env` 文件。

### 6.2 工具分类共识
必须在代码结构和命名上明确区分两类工具：

1.  **逻辑工具 (Logic Tools)**:
    *   **前缀**: `mcp_rag_flow_` (保持现有命名或根据模块命名)
    *   **职责**: 编排多个原子操作，实现特定业务场景（如 Review Flow）。
    *   **特征**: 有状态、有流程、可能调用多个原子工具或引擎。
    *   **示例**: `fill_clarification_suggestions`, `evolve_scheme_document`.

2.  **实施工具 (Implementation Tools)**:
    *   **前缀**: `mcp_rag_base_` (建议新前缀以示区分)
    *   **职责**: 执行单一、无状态的原子操作。
    *   **特征**: 输入输出简单直接，不包含复杂业务判断。
    *   **示例**: `create_dataset`, `upload_document`, `list_datasets`.

### 6.3 知识库管理共识
*   **CRUD 完备性**: 提供完整的知识库和文档管理能力，允许用户通过 MCP Client 直接维护 RAGFlow 数据。
*   **操作映射**: 每个工具应直接映射到 RAGFlow API 的一个或一组相关端点。

